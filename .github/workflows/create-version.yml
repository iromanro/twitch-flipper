name: create-version
on:
  push:
    branches:
      - dan-updates

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: dan-updates

      - name: Configure Github credentials
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Bump package version
        run: |
          echo "bumping version on branch $(git branch --show-current)"
          npm version patch

      - name: Update version in manifest.json
        run: |
          # TODO: replace "version": "..." with new version

      - name: Run build script
        run: |
          npm run build

      - name: Set new version
        id: new_version
        run: |
          # get the new version from package.json
          NEW_VERSION_NUMBER=$(node -e "console.log(require('./package.json').version);")
          echo "new version = $NEW_VERSION_NUMBER"
          
          # set the new version as an output of this step (github syntax)
          echo "::set-output name=NEW_VERSION_NUMBER::$NEW_VERSION_NUMBER"

      - name: Package distribution
        run: |
          # get new version number
          VER=${{ steps.new_version.outputs.NEW_VERSION_NUMBER }}
          
          # create builds directory
          BUILDS_DIR=builds
          mkdir -p $BUILDS_DIR

          # create a file name from the new version
          FILENAME=$VER.zip

          # zip up deployment package
          cd dist
          zip -r ../$BUILDS_DIR/$FILENAME .
          cd ..

      - name: Commit new version and push
        run: |
          # get new version number
          VER=${{ steps.new_version.outputs.NEW_VERSION_NUMBER }}

          # commit and push changes
          git add .
          git commit -m "new version - $VER"
          git push