name: create-version
on:
  push:
    branches:
      - dan-updates

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: dan-updates

      - name: Configure Github credentials
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Bump package version
        run: |
          echo "bumping version on branch $(git branch --show-current)"
          npm version patch

      - name: Update manifest.json version
        run: |


      - name: Run build script
        run: |
          npm run build

      - name: Set new version
        id: new_version
        run: |
          NEW_VERSION_NUMBER=$(node -e "console.log(require('./package.json').version);")
          echo "::set-output name=NEW_VERSION_NUMBER::$NEW_VERSION_NUMBER"

      - name: Package distribution
        run: |
          VER=${{ steps.new_version.outputs.NEW_VERSION_NUMBER }}
          echo VER = $VER
          
          BUILDS_DIR=builds
          mkdir -p $BUILDS_DIR

          cd dist
          zip -r ../$BUILDS_DIR/$VER.zip .
          cd ..

          ls -alrt

      - name: Commit new version and push
        run: |
          VER=${{ steps.new_version.outputs.NEW_VERSION_NUMBER }}
          echo VER = $VER

          git add .
          git commit -m "new version - $VER"
          git push